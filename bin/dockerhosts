#!/usr/bin/env bash

# Messy hack to give all docker containers a *.docker host name locally

set -e

BACKUP=/tmp/etc_hosts.backup

# Backup existing hosts file
sudo cp /etc/hosts $BACKUP
# Strip old .docker hosts out
sudo BACKUP="$BACKUP" sh -c 'cat $BACKUP | sudo grep -v \.docker > /etc/hosts'

# Get all running docker containers
#
docker_hosts=$(docker ps -q)

# Append hosts entry
for i in $docker_hosts; do
    ip=$(docker inspect --format '{{.NetworkSettings.IPAddress}}' $i)
    name=$(docker inspect --format '{{.Name}}' $i)
    # strip the leading '/'
    name=${name:1}
    line="$ip\t$name.docker"
    sudo line="$line" sh -c 'echo $line >> /etc/hosts'
done

echo "******* NEW HOSTS *******"
cat /etc/hosts

